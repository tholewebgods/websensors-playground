<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title></title>
	<style type="text/css">
		h4 span {
			display: block;
			width: 70px;
			text-align: right;
		}
	</style>
</head>
<body>
<h1>Absolute orientation sensor</h1>
<p>
	<h3>Quaternion:</h3>
	<h4 id="quaternion">
		<span id="qr">r=0.000</span>
		<span id="qi">i=0.000</span>
		<span id="qj">j=0.000</span>
		<span id="qk">q=0.000</span>
		<span id="aaTheta">θ=0.0</span>
	</h4>
</p>

<script type="text/javascript">
function fail(msg) {
	const el = document.querySelector("#quaternion");
	el.textContent = "Sensor is not available.";
}

/**
 * Get the axis angle rotation.
 *
 * See https://en.wikipedia.org/wiki/Quaternions_and_spatial_rotation#Recovering_the_axis-angle_representation
 */
function axisAngleRotation(quaternion) {
	const [qr, qi, qj, qk] = quaternion;
	return 2 * Math.atan2(Math.sqrt(qi**2 + qj**2 + qk**2), qr) * 180 / Math.PI;
}

function start() {
	const qrEl = document.querySelector("#qr");
	const qiEl = document.querySelector("#qi");
	const qjEl = document.querySelector("#qj");
	const qkEl = document.querySelector("#qk");
	const aaThetaEl = document.querySelector("#aaTheta");
	const options = {
		frequency: 60,
		referenceFrame: 'device'
	};
	const sensor = new AbsoluteOrientationSensor(options);

	sensor.addEventListener('reading', () => {
		qrEl.textContent = `r=${sensor.quaternion[0].toFixed(3)}`;
		qiEl.textContent = `i=${sensor.quaternion[1].toFixed(3)}`;
		qjEl.textContent = `j=${sensor.quaternion[2].toFixed(3)}`;
		qkEl.textContent = `k=${sensor.quaternion[3].toFixed(3)}`;

		const theta = axisAngleRotation(sensor.quaternion);
		aaThetaEl.textContent = `θ=${theta.toFixed(1)}`;
	});

	sensor.addEventListener('error', error => {
		if (event.error.name == 'NotReadableError') {
			fail("Sensor is not available.");
		} else {
			fail(`Other error occured: ${event.error.toString()}`);
		}
	});

	sensor.start();
}

function main() {
	Promise.all([
		navigator.permissions.query({ name: "accelerometer" }),
		navigator.permissions.query({ name: "magnetometer" }),
		navigator.permissions.query({ name: "gyroscope" })
	]).then((results) => {
		if (results.every(result => result.state === "granted")) {
			start();
		} else {
			fail("No permissions to use AbsoluteOrientationSensor.");
		}
	});
}

window.onload = main;
</script>
</body>
</html>
