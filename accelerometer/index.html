<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title></title>
	<style type="text/css">
		h4 span {
			display: block;
			width: 70px;
			text-align: right;
		}
	</style>
</head>
<body>
<h1>Accelerometer</h1>
<p>
	<h3>Axis</h3>
	<h4 id="axis">
		<span id="x">x=0.00</span>
		<span id="y">y=0.00</span>
		<span id="z">z=0.00</span>
	</h4>
	<h3>Axis peak reading</h3>
	<h4 id="axis">
		<span id="peak-x">x=0.00</span>
		<span id="peak-y">y=0.00</span>
		<span id="peak-z">z=0.00</span>
	</h4>
</p>

<script type="text/javascript">
function fail(msg) {
	const el = document.querySelector("#axis");
	el.textContent = "Sensor is not available.";
}

/**
 * Max value ignoring the sign.
 */
function maxAbs(a, b) {
	if (Math.abs(a) > Math.abs(b)) {
		return a;
	}

	return b;
}

function start() {
	const xEl = document.querySelector("#x");
	const yEl = document.querySelector("#y");
	const zEl = document.querySelector("#z");
	const peakXEl = document.querySelector("#peak-x");
	const peakYEl = document.querySelector("#peak-y");
	const peakZEl = document.querySelector("#peak-z");
	const options = {
		frequency: 60,
		referenceFrame: 'device'
	};
	const sensor = new Accelerometer(options);
	const peakReading = { x: 0, y: 0, z: 0 };

	sensor.addEventListener('reading', () => {
		peakXEl.textContent = `x=${peakReading.x.toFixed(2)}`;
		peakYEl.textContent = `y=${peakReading.y.toFixed(2)}`;
		peakZEl.textContent = `z=${peakReading.z.toFixed(2)}`;

		peakReading.x = maxAbs(peakReading.x, sensor.x);
		peakReading.y = maxAbs(peakReading.y, sensor.y);
		peakReading.z = maxAbs(peakReading.z, sensor.z);

		xEl.textContent = `x=${sensor.x.toFixed(2)}`;
		yEl.textContent = `y=${sensor.y.toFixed(2)}`;
		zEl.textContent = `z=${sensor.z.toFixed(2)}`;
	});

	sensor.addEventListener('error', error => {
		if (event.error.name == 'NotReadableError') {
			fail("Sensor is not available.");
		} else {
			fail(`Other error occured: ${event.error.toString()}`);
		}
	});

	sensor.start();
}

function main() {
	navigator.permissions
		.query({ name: "accelerometer" })
		.then((result) => {
			if (result.state === "granted") {
				start();
			} else {
				fail("No permissions to use AbsoluteOrientationSensor.");
			}
		});
}

window.onload = main;
</script>
</body>
</html>
